@page "/employees"
@using AttendanceManagement.Interfaces
@using AttendanceManagement.Permissions
@using AttendanceManagement.Dtos.Schedules
@using System.IO
@using Volo.Abp.Application.Dtos
@using Volo.Abp.AspNetCore.Components.Messages
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using AttendanceManagement.Dtos.Employees
@attribute [Authorize(AttendanceManagementPermissions.Employees.Default)]
@inject IEmployeeAppService EmployeeAppService
@inject IGroupAppService GroupAppService
@inject IWorkflowAppService WorkflowAppService
@inject IScheduleAppService ScheduleAppService
@inject IUiMessageService MessageService
@inject IAuthorizationService AuthorizationService
@inject IStringLocalizer<AttendanceManagementResource> L
@inject IJSRuntime JSRuntime
@inherits AbpComponentBase

<div class="modern-page-wrapper">
    <div class="glass-card">
        @* Header Section *@
        <div class="gradient-header">
            <div class="gradient-header-content">
                <Row Class="justify-content-between align-items-center">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex align-items-center gap-3">
                            <div class="header-icon-box">
                                <Icon Name="IconName.Users" />
                            </div>
                            <div>
                                <Heading Size="HeadingSize.Is3" TextColor="TextColor.White" Margin="Margin.Is0">
                                    @L["Employees"]
                                </Heading>
                                <p class="text-white-50 mb-0 mt-1 small">@L["ManageEmployeeInformation"]</p>
                            </div>
                        </div>
                    </Column>
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex gap-2">
                            @if (HasCreatePermission)
                            {
                                <Button Class="btn-modern" Clicked="DownloadTemplateAsync" Loading="@IsDownloadingTemplate">
                                    <Icon Name="IconName.FileAlt" />
                                    <span>@L["DownloadTemplate"]</span>
                                </Button>
                                <label class="btn-modern" style="cursor: pointer; margin: 0;">
                                    <Icon Name="IconName.FileUpload" />
                                    <span>@L["ImportExcel"]</span>
                                    <InputFile OnChange="HandleFileSelected" accept=".xlsx,.xls" style="display: none;" />
                                </label>
                            }
                            @if (HasExportPermission && EmployeeList != null && EmployeeList.Any())
                            {
                                <Button Class="btn-modern" Clicked="ExportToExcelAsync" Loading="@IsExporting">
                                    <Icon Name="IconName.FileDownload" />
                                    <span>@L["ExportToExcel"]</span>
                                </Button>
                            }
                            @if (HasCreatePermission)
                            {
                                <Button Class="btn-modern" Clicked="OpenCreateModalAsync">
                                    <Icon Name="IconName.Add" />
                                    <span>@L["NewEmployee"]</span>
                                </Button>
                            }
                        </div>
                    </Column>
                </Row>
            </div>
        </div>

        @* Loading State *@
        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="modern-spinner mx-auto mb-3"></div>
                <p class="text-muted">@L["Loading"]</p>
            </div>
        }
        else if (EmployeeList != null && EmployeeList.Any())
        {
            @* Content Section *@
            <div class="px-4 pb-4">
                <div class="modern-table-wrapper" style="max-height: 600px; overflow-y: auto;">
                    <Table Class="modern-table" Margin="Margin.Is0">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>@L["Name"]</TableHeaderCell>
                                <TableHeaderCell>@L["Department"]</TableHeaderCell>
                                <TableHeaderCell>@L["Sector"]</TableHeaderCell>
                                <TableHeaderCell>@L["Group"]</TableHeaderCell>
                                <TableHeaderCell>@L["Status"]</TableHeaderCell>
                                <TableHeaderCell>@L["Actions"]</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var employee in EmployeeList)
                            {
                                <TableRow>
                                    <TableRowCell>
                                        <a href="javascript:void(0)" @onclick="@(() => OpenDetailsModalAsync(employee.Id))" style="color: var(--ejada-primary); font-weight: 600; text-decoration: none;">
                                            @employee.Name
                                        </a>
                                    </TableRowCell>
                                    <TableRowCell>@employee.Department</TableRowCell>
                                    <TableRowCell>@employee.Sector</TableRowCell>
                                    <TableRowCell>@(employee.GroupName ?? "-")</TableRowCell>
                                    <TableRowCell>
                                        @if (employee.IsActive)
                                        {
                                            <Badge Color="Color.Success">@L["Active"]</Badge>
                                        }
                                        else
                                        {
                                            <Badge Color="Color.Secondary">@L["Inactive"]</Badge>
                                        }
                                    </TableRowCell>
                                    <TableRowCell>
                                        <Dropdown>
                                            <DropdownToggle Color="Color.Primary" Size="Size.Small">
                                                @L["Actions"]
                                            </DropdownToggle>
                                            <DropdownMenu>
                                                <DropdownItem Clicked="@(() => OpenDetailsModalAsync(employee.Id))">
                                                    <Icon Name="IconName.Eye" /> @L["Details"]
                                                </DropdownItem>
                                                @if (HasUpdatePermission)
                                                {
                                                    <DropdownItem Clicked="@(() => OpenEditModalAsync(employee.Id))">
                                                        <Icon Name="IconName.Edit" /> @L["Edit"]
                                                    </DropdownItem>
                                                    @if (employee.IsActive)
                                                    {
                                                        <DropdownItem Clicked="@(() => DeactivateEmployeeAsync(employee.Id))">
                                                            <Icon Name="IconName.Ban" /> @L["Deactivate"]
                                                        </DropdownItem>
                                                    }
                                                    else
                                                    {
                                                        <DropdownItem Clicked="@(() => ActivateEmployeeAsync(employee.Id))">
                                                            <Icon Name="IconName.Check" /> @L["Activate"]
                                                        </DropdownItem>
                                                    }
                                                }
                                            </DropdownMenu>
                                        </Dropdown>
                                    </TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                </div>
                
                @* Pagination Controls *@
                @if (TotalPages > 1 || TotalCount > PageSize)
                {
                    <div class="d-flex justify-content-between align-items-center mt-4 px-2 flex-wrap gap-3">
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <span class="text-muted small">
                                @L["Showing"] @((CurrentPage - 1) * PageSize + 1) - @(Math.Min(CurrentPage * PageSize, TotalCount)) @L["Of"] @TotalCount @L["Employees"]
                            </span>
                            <div class="d-flex align-items-center gap-1 ms-3">
                                <span class="text-muted small">@L["PageSize"]:</span>
                                <Select TValue="int" SelectedValue="@PageSize" SelectedValueChanged="@OnPageSizeChanged" Style="width: 80px;">
                                    <SelectItem Value="10">10</SelectItem>
                                    <SelectItem Value="25">25</SelectItem>
                                    <SelectItem Value="50">50</SelectItem>
                                    <SelectItem Value="100">100</SelectItem>
                                </Select>
                            </div>
                        </div>
                        @if (TotalPages > 1)
                        {
                            <div class="d-flex align-items-center gap-2">
                                <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => LoadPageAsync(1))" Disabled="@(CurrentPage == 1)">
                                    <Icon Name="IconName.ChevronLeft" />
                                </Button>
                                <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => LoadPageAsync(CurrentPage - 1))" Disabled="@(CurrentPage == 1)">
                                    <Icon Name="IconName.AngleLeft" />
                                    @L["Previous"]
                                </Button>
                                <div class="d-flex align-items-center gap-1">
                                    @for (int i = Math.Max(1, CurrentPage - 2); i <= Math.Min(TotalPages, CurrentPage + 2); i++)
                                    {
                                        var pageNum = i;
                                        <Button Color="@(pageNum == CurrentPage ? Color.Primary : Color.Secondary)" 
                                                Size="Size.Small" 
                                                Clicked="@(() => LoadPageAsync(pageNum))"
                                                Style="@(pageNum == CurrentPage ? "font-weight: bold;" : "")">
                                            @pageNum
                                        </Button>
                                    }
                                </div>
                                <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => LoadPageAsync(CurrentPage + 1))" Disabled="@(CurrentPage >= TotalPages)">
                                    @L["Next"]
                                    <Icon Name="IconName.AngleRight" />
                                </Button>
                                <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => LoadPageAsync(TotalPages))" Disabled="@(CurrentPage >= TotalPages)">
                                    <Icon Name="IconName.ChevronRight" />
                                </Button>
                            </div>
                        }
                    </div>
                }
                else if (TotalCount > 0)
                {
                    <div class="d-flex justify-content-between align-items-center mt-4 px-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small">@L["Showing"] @TotalCount @L["Employees"]</span>
                            <div class="d-flex align-items-center gap-1 ms-3">
                                <span class="text-muted small">@L["PageSize"]:</span>
                                <Select TValue="int" SelectedValue="@PageSize" SelectedValueChanged="@OnPageSizeChanged" Style="width: 80px;">
                                    <SelectItem Value="10">10</SelectItem>
                                    <SelectItem Value="25">25</SelectItem>
                                    <SelectItem Value="50">50</SelectItem>
                                    <SelectItem Value="100">100</SelectItem>
                                </Select>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="p-5">
                <div class="alert-modern">
                    <h4 class="alert-modern-heading">
                        <Icon Name="IconName.InfoCircle" Margin="Margin.Is1.FromEnd" />
                        @L["NoRecordsFound"]
                    </h4>
                    <p class="alert-modern-text mb-0">
                        @L["NoEmployeesAvailable"]
                    </p>
                </div>
            </div>
        }
    </div>
</div>

<Modal @ref="EmployeeModal">
    <ModalContent Centered="true" Size="ModalSize.Large">
        <Form>
            <ModalHeader>
                <ModalTitle>@ModalTitle</ModalTitle>
                <CloseButton Clicked="CloseEmployeeModal" />
            </ModalHeader>
            <ModalBody>
                @if (EditingEmployee != null)
                {
                    <Field>
                        <FieldLabel>@L["Name"] *</FieldLabel>
                        <TextEdit @bind-Text="@EditingEmployee.Name" Placeholder="Enter employee name" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["Department"]</FieldLabel>
                        <TextEdit @bind-Text="@EditingEmployee.Department" Placeholder="Enter department" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["Sector"]</FieldLabel>
                        <TextEdit @bind-Text="@EditingEmployee.Sector" Placeholder="Enter sector" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["Email"]</FieldLabel>
                        <TextEdit @bind-Text="@EditingEmployee.Email" Placeholder="Enter email address" Type="InputType.Email" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["CompanyId"]</FieldLabel>
                        <TextEdit @bind-Text="@EditingEmployee.CompanyId" Placeholder="Enter company ID" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["Group"]</FieldLabel>
                        <Select TValue="Guid?" @bind-SelectedValue="@EditingEmployee.GroupId">
                            <SelectItem Value="@((Guid?)null)">-- @L["Select"] --</SelectItem>
                            @if (Groups != null)
                            {
                                @foreach (var group in Groups)
                                {
                                    <SelectItem Value="@group.Id">@group.Name</SelectItem>
                                }
                            }
                        </Select>
                    </Field>
                    <Field>
                        <FieldLabel>@L["Workflow"]</FieldLabel>
                        <Select TValue="Guid?" @bind-SelectedValue="@EditingEmployee.WorkflowId">
                            <SelectItem Value="@((Guid?)null)">-- @L["Select"] --</SelectItem>
                            @if (Workflows != null)
                            {
                                @foreach (var workflow in Workflows)
                                {
                                    <SelectItem Value="@workflow.Id">@workflow.Name</SelectItem>
                                }
                            }
                        </Select>
                    </Field>
                }
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="CloseEmployeeModal">@L["Cancel"]</Button>
                <Button Color="Color.Primary" Clicked="SaveEmployeeAsync" Loading="@IsSaving">
                    @L["Save"]
                </Button>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

<Modal @ref="DetailsModal">
    <ModalContent Centered="true" Size="ModalSize.Large">
        <ModalHeader>
            <ModalTitle>@L["EmployeeDetails"]</ModalTitle>
            <CloseButton Clicked="CloseDetailsModal" />
        </ModalHeader>
        <ModalBody>
            @if (SelectedEmployeeDetails != null)
            {
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["Name"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        <Text>@SelectedEmployeeDetails.Name</Text>
                    </FieldBody>
                </Field>
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["Department"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        <Text>@SelectedEmployeeDetails.Department</Text>
                    </FieldBody>
                </Field>
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["Sector"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        <Text>@SelectedEmployeeDetails.Sector</Text>
                    </FieldBody>
                </Field>
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["Email"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        <Text>@(SelectedEmployeeDetails.Email ?? "-")</Text>
                    </FieldBody>
                </Field>
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["CompanyId"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        <Text>@(SelectedEmployeeDetails.CompanyId ?? "-")</Text>
                    </FieldBody>
                </Field>
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["Group"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        <Text>@(SelectedEmployeeDetails.GroupName ?? "-")</Text>
                    </FieldBody>
                </Field>
                <Field Horizontal="true">
                    <FieldLabel ColumnSize="ColumnSize.Is3">@L["Status"]</FieldLabel>
                    <FieldBody ColumnSize="ColumnSize.Is9">
                        @if (SelectedEmployeeDetails.IsActive)
                        {
                            <Badge Color="Color.Success">@L["Active"]</Badge>
                        }
                        else
                        {
                            <Badge Color="Color.Secondary">@L["Inactive"]</Badge>
                        }
                    </FieldBody>
                </Field>
                <Divider Margin="Margin.Is4.FromTop" />
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>@L["ScheduleAssignments"]</h5>
                    @if (HasScheduleAssignPermission)
                    {
                        <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => OpenAssignScheduleModal(SelectedEmployeeDetails.Id))">
                            <Icon Name="IconName.Add" /> @L["AssignSchedule"]
                        </Button>
                    }
                </div>
                @if (ScheduleAssignments != null && ScheduleAssignments.Any())
                {
                    <Table Striped="true" Hoverable="true" Responsive="true">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>@L["Schedule"]</TableHeaderCell>
                                <TableHeaderCell>@L["EffectiveFrom"]</TableHeaderCell>
                                <TableHeaderCell>@L["EffectiveTo"]</TableHeaderCell>
                                <TableHeaderCell>@L["SeatNumber"]</TableHeaderCell>
                                <TableHeaderCell>@L["FloorNumber"]</TableHeaderCell>
                                <TableHeaderCell>@L["Actions"]</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var assignment in ScheduleAssignments)
                            {
                                <TableRow>
                                    <TableRowCell>@assignment.ScheduleName</TableRowCell>
                                    <TableRowCell>@assignment.EffectiveFrom.ToString("yyyy-MM-dd")</TableRowCell>
                                    <TableRowCell>@(assignment.EffectiveTo?.ToString("yyyy-MM-dd") ?? L["Ongoing"])</TableRowCell>
                                    <TableRowCell>@assignment.SeatNumber</TableRowCell>
                                    <TableRowCell>@assignment.FloorNumber</TableRowCell>
                                    <TableRowCell>
                                        @if (HasScheduleAssignPermission)
                                        {
                                            <Dropdown>
                                                <DropdownToggle Color="Color.Primary" Size="Size.Small">
                                                    @L["Actions"]
                                                </DropdownToggle>
                                                <DropdownMenu>
                                                    <DropdownItem Clicked="@(() => OpenEditScheduleModal(assignment))">
                                                        <Icon Name="IconName.Edit" /> @L["Edit"]
                                                    </DropdownItem>
                                                    @if (assignment.EffectiveTo == null)
                                                    {
                                                        <DropdownItem Clicked="@(() => EndScheduleAssignmentAsync(assignment.Id))">
                                                            <Icon Name="IconName.Stop" /> @L["EndAssignment"]
                                                        </DropdownItem>
                                                    }
                                                </DropdownMenu>
                                            </Dropdown>
                                        }
                                    </TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                }
                else
                {
                    <Alert Color="Color.Info">
                        <AlertDescription>@L["NoScheduleAssignments"]</AlertDescription>
                    </Alert>
                }
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseDetailsModal">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Modal @ref="ScheduleAssignmentModal">
    <ModalContent Centered="true" Size="ModalSize.Large">
        <Form>
            <ModalHeader>
                <ModalTitle>@ScheduleAssignmentModalTitle</ModalTitle>
                <CloseButton Clicked="CloseScheduleAssignmentModal" />
            </ModalHeader>
            <ModalBody>
                @if (EditingScheduleAssignment != null)
                {
                    <Field>
                        <FieldLabel>@L["Schedule"] *</FieldLabel>
                        <Select TValue="Guid" @bind-SelectedValue="@EditingScheduleAssignment.ScheduleId">
                            <SelectItem Value="@Guid.Empty">-- @L["Select"] --</SelectItem>
                            @if (Schedules != null)
                            {
                                @foreach (var schedule in Schedules)
                                {
                                    <SelectItem Value="@schedule.Id">@schedule.Name</SelectItem>
                                }
                            }
                        </Select>
                    </Field>
                    <Field>
                        <FieldLabel>@L["EffectiveFrom"] *</FieldLabel>
                        <TextEdit Type="date" @bind-Text="@EffectiveFromString" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["EffectiveTo"]</FieldLabel>
                        <TextEdit Type="date" @bind-Text="@EffectiveToString" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["SeatNumber"]</FieldLabel>
                        <TextEdit @bind-Text="@EditingScheduleAssignment.SeatNumber" Placeholder="Enter seat number" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["FloorNumber"]</FieldLabel>
                        <TextEdit @bind-Text="@EditingScheduleAssignment.FloorNumber" Placeholder="Enter floor number" />
                    </Field>
                }
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="CloseScheduleAssignmentModal">@L["Cancel"]</Button>
                <Button Color="Color.Primary" Clicked="SaveScheduleAssignmentAsync" Loading="@IsSavingSchedule">
                    @L["Save"]
                </Button>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

@* Import Results Modal *@
<Modal @ref="ImportResultsModal" Size="ModalSize.ExtraLarge">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>@L["ImportResults"]</ModalTitle>
        </ModalHeader>
        <ModalBody>
            @if (ImportResult != null)
            {
                <div class="mb-3">
                    <div class="d-flex gap-4 mb-3">
                        <div class="p-3 rounded" style="background: #f0f9ff; border-left: 4px solid #3b82f6;">
                            <div class="small text-muted mb-1">@L["TotalRows"]</div>
                            <div class="fs-4 fw-bold">@ImportResult.TotalRows</div>
                        </div>
                        <div class="p-3 rounded" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                            <div class="small text-muted mb-1">@L["SuccessfullyImported"]</div>
                            <div class="fs-4 fw-bold" style="color: #10b981;">@ImportResult.SuccessCount</div>
                        </div>
                        <div class="p-3 rounded" style="background: #fef2f2; border-left: 4px solid #ef4444;">
                            <div class="small text-muted mb-1">@L["Failed"]</div>
                            <div class="fs-4 fw-bold" style="color: #ef4444;">@ImportResult.FailureCount</div>
                        </div>
                    </div>
                </div>

                @if (ImportResult.Errors != null && ImportResult.Errors.Any())
                {
                    <div class="alert alert-warning">
                        <Icon Name="IconName.ExclamationTriangle" />
                        <strong>@L["ImportErrors"]</strong>
                        <p class="mb-0">@L["ImportErrorsMessage"]</p>
                    </div>

                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <Table Class="table table-sm">
                            <TableHeader>
                                <TableRow>
                                    <TableHeaderCell>@L["RowNumber"]</TableHeaderCell>
                                    <TableHeaderCell>@L["EmployeeName"]</TableHeaderCell>
                                    <TableHeaderCell>@L["Errors"]</TableHeaderCell>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                @foreach (var error in ImportResult.Errors)
                                {
                                    <TableRow>
                                        <TableRowCell>@error.RowNumber</TableRowCell>
                                        <TableRowCell>@error.EmployeeName</TableRowCell>
                                        <TableRowCell>
                                            <ul class="mb-0" style="padding-left: 20px;">
                                                @foreach (var errorMsg in error.ErrorMessages)
                                                {
                                                    <li class="text-danger">@errorMsg</li>
                                                }
                                            </ul>
                                        </TableRowCell>
                                    </TableRow>
                                }
                            </TableBody>
                        </Table>
                    </div>
                }
                else if (ImportResult.SuccessCount > 0)
                {
                    <div class="alert alert-success">
                        <Icon Name="IconName.CheckCircle" />
                        <strong>@L["ImportSuccess"]</strong>
                        <p class="mb-0">@L["ImportSuccessMessage"]</p>
                    </div>
                }
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Primary" Clicked="CloseImportResultsModal">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private List<EmployeeDto> EmployeeList { get; set; }
    private int TotalCount { get; set; }
    private int PageSize { get; set; } = 10;
    private int CurrentPage { get; set; } = 1;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);
    private bool IsLoading { get; set; } = true;
    private bool IsSaving { get; set; }

    private Modal EmployeeModal { get; set; }
    private Modal DetailsModal { get; set; }
    private Modal ScheduleAssignmentModal { get; set; }
    private Modal ImportResultsModal { get; set; }

    private CreateUpdateEmployeeDto EditingEmployee { get; set; }
    private Guid? EditingEmployeeId { get; set; }
    private EmployeeWithDetailsDto SelectedEmployeeDetails { get; set; }
    private string ModalTitle { get; set; }

    private List<GroupDto> Groups { get; set; }
    private List<WorkflowDto> Workflows { get; set; }
    private List<ScheduleDto> Schedules { get; set; }
    private List<ScheduleAssignmentDto> ScheduleAssignments { get; set; }

    private AssignScheduleDto EditingScheduleAssignment { get; set; }
    private Guid? EditingScheduleAssignmentId { get; set; }
    private Guid? AssigningEmployeeId { get; set; }
    private string ScheduleAssignmentModalTitle { get; set; }
    private string EffectiveFromString { get; set; }
    private string EffectiveToString { get; set; }
    private bool IsSavingSchedule { get; set; }

    private bool HasCreatePermission { get; set; }
    private bool HasUpdatePermission { get; set; }
    private bool HasScheduleAssignPermission { get; set; }
    private bool HasExportPermission { get; set; }
    private bool IsExporting { get; set; }
    private bool IsDownloadingTemplate { get; set; }
    private bool IsImporting { get; set; }
    private ImportResultDto ImportResult { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await SetPermissionsAsync();
            await LoadGroupsAsync();
            await LoadWorkflowsAsync();
            await LoadSchedulesAsync();
            await LoadEmployeesAsync();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error initializing: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SetPermissionsAsync()
    {
        HasCreatePermission = await AuthorizationService.IsGrantedAsync(AttendanceManagementPermissions.Employees.Create);
        HasUpdatePermission = await AuthorizationService.IsGrantedAsync(AttendanceManagementPermissions.Employees.Edit);
        HasScheduleAssignPermission = await AuthorizationService.IsGrantedAsync(AttendanceManagementPermissions.Schedules.Assign);
        HasExportPermission = await AuthorizationService.IsGrantedAsync(AttendanceManagementPermissions.Employees.Export);
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var input = new PagedAndSortedResultRequestDto
            {
                SkipCount = (CurrentPage - 1) * PageSize,
                MaxResultCount = PageSize
            };

            var result = await EmployeeAppService.GetListAsync(input);
            EmployeeList = result.Items.ToList();
            TotalCount = (int)result.TotalCount;
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error loading employees: {ex.Message}");
            EmployeeList = new List<EmployeeDto>();
        }
    }

    private async Task LoadPageAsync(int page)
    {
        CurrentPage = page;
        IsLoading = true;
        await LoadEmployeesAsync();
        IsLoading = false;
    }

    private async Task OnPageSizeChanged(int newPageSize)
    {
        PageSize = newPageSize;
        CurrentPage = 1; // Reset to first page when page size changes
        IsLoading = true;
        await LoadEmployeesAsync();
        IsLoading = false;
    }

    private async Task LoadGroupsAsync()
    {
        try
        {
            Groups = await GroupAppService.GetActiveGroupsAsync();
        }
        catch (Exception ex)
        {
            Groups = new List<GroupDto>();
            await MessageService.Error($"Error loading groups: {ex.Message}");
        }
    }

    private async Task LoadWorkflowsAsync()
    {
        try
        {
            Workflows = await WorkflowAppService.GetActiveWorkflowsAsync();
        }
        catch (Exception ex)
        {
            Workflows = new List<WorkflowDto>();
            await MessageService.Error($"Error loading workflows: {ex.Message}");
        }
    }

    private async Task LoadSchedulesAsync()
    {
        try
        {
            Schedules = await ScheduleAppService.GetActiveSchedulesAsync();
        }
        catch (Exception ex)
        {
            Schedules = new List<ScheduleDto>();
            await MessageService.Error($"Error loading schedules: {ex.Message}");
        }
    }

    private async Task OpenCreateModalAsync()
    {
        try
        {
            EditingEmployeeId = null;
            EditingEmployee = new CreateUpdateEmployeeDto();
            ModalTitle = L["NewEmployee"];
            await EmployeeModal.Show();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error opening create modal: {ex.Message}");
        }
    }

    private async Task OpenEditModalAsync(Guid id)
    {
        try
        {
            EditingEmployeeId = id;
            var employee = await EmployeeAppService.GetAsync(id);
            EditingEmployee = new CreateUpdateEmployeeDto
            {
                UserId = employee.UserId,
                Name = employee.Name,
                Department = employee.Department,
                Sector = employee.Sector,
                Email = employee.Email,
                CompanyId = employee.CompanyId,
                GroupId = employee.GroupId,
                WorkflowId = employee.WorkflowId
            };
            ModalTitle = L["EditEmployee"];
            await EmployeeModal.Show();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error loading employee: {ex.Message}");
        }
    }

    private async Task OpenDetailsModalAsync(Guid id)
    {
        try
        {
            SelectedEmployeeDetails = await EmployeeAppService.GetWithDetailsAsync(id);
            ScheduleAssignments = await ScheduleAppService.GetEmployeeScheduleAssignmentsAsync(id);
            await DetailsModal.Show();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error loading details: {ex.Message}");
        }
    }

    private async Task OpenAssignScheduleModal(Guid employeeId)
    {
        try
        {
            if (Schedules == null || !Schedules.Any())
            {
                await LoadSchedulesAsync();
            }

            AssigningEmployeeId = employeeId;
            EditingScheduleAssignmentId = null;
            EditingScheduleAssignment = new AssignScheduleDto
            {
                EmployeeId = employeeId,
                EffectiveFrom = DateTime.UtcNow.Date
            };
            EffectiveFromString = DateTime.UtcNow.Date.ToString("yyyy-MM-dd");
            EffectiveToString = string.Empty;
            ScheduleAssignmentModalTitle = L["AssignSchedule"];
            await ScheduleAssignmentModal.Show();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error opening assign schedule modal: {ex.Message}");
        }
    }

    private async Task OpenEditScheduleModal(ScheduleAssignmentDto assignment)
    {
        try
        {
            if (Schedules == null || !Schedules.Any())
            {
                await LoadSchedulesAsync();
            }

            EditingScheduleAssignmentId = assignment.Id;
            AssigningEmployeeId = assignment.EmployeeId;
            EditingScheduleAssignment = new AssignScheduleDto
            {
                ScheduleId = assignment.ScheduleId,
                EmployeeId = assignment.EmployeeId,
                EffectiveFrom = assignment.EffectiveFrom,
                EffectiveTo = assignment.EffectiveTo,
                SeatNumber = assignment.SeatNumber,
                FloorNumber = assignment.FloorNumber
            };
            EffectiveFromString = assignment.EffectiveFrom.ToString("yyyy-MM-dd");
            EffectiveToString = assignment.EffectiveTo?.ToString("yyyy-MM-dd") ?? string.Empty;
            ScheduleAssignmentModalTitle = L["EditScheduleAssignment"];
            await ScheduleAssignmentModal.Show();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error opening edit schedule modal: {ex.Message}");
        }
    }

    private async Task CloseScheduleAssignmentModal()
    {
        await ScheduleAssignmentModal.Hide();
        EditingScheduleAssignment = null;
        EditingScheduleAssignmentId = null;
        AssigningEmployeeId = null;
        StateHasChanged();
    }

    private async Task SaveScheduleAssignmentAsync()
    {
        try
        {
            if (EditingScheduleAssignment == null)
            {
                await MessageService.Error("Schedule assignment data is missing.");
                return;
            }

            if (EditingScheduleAssignment.ScheduleId == Guid.Empty)
            {
                await MessageService.Error("Please select a schedule.");
                return;
            }

            if (string.IsNullOrEmpty(EffectiveFromString) || !DateTime.TryParse(EffectiveFromString, out var effectiveFrom))
            {
                await MessageService.Error("Please enter a valid effective from date.");
                return;
            }

            EditingScheduleAssignment.EffectiveFrom = effectiveFrom;
            EditingScheduleAssignment.EffectiveTo = !string.IsNullOrEmpty(EffectiveToString) && DateTime.TryParse(EffectiveToString, out var effectiveTo) ? effectiveTo : null;

            IsSavingSchedule = true;

            if (EditingScheduleAssignmentId == null)
            {
                await ScheduleAppService.AssignScheduleAsync(EditingScheduleAssignment);
                await MessageService.Success(L["ScheduleAssignedSuccessfully"]);
            }
            else
            {
                await ScheduleAppService.UpdateScheduleAssignmentAsync(EditingScheduleAssignmentId.Value, EditingScheduleAssignment);
                await MessageService.Success(L["ScheduleAssignmentUpdatedSuccessfully"]);
            }

            await CloseScheduleAssignmentModal();
            if (SelectedEmployeeDetails != null && AssigningEmployeeId.HasValue)
            {
                ScheduleAssignments = await ScheduleAppService.GetEmployeeScheduleAssignmentsAsync(AssigningEmployeeId.Value);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error saving schedule assignment: {ex.Message}");
        }
        finally
        {
            IsSavingSchedule = false;
        }
    }

    private async Task EndScheduleAssignmentAsync(Guid assignmentId)
    {
        try
        {
            var confirmed = await MessageService.Confirm(L["EndScheduleAssignmentConfirmation"], L["Confirm"]);
            if (!confirmed)
            {
                return;
            }

            await ScheduleAppService.EndScheduleAssignmentAsync(assignmentId, DateTime.UtcNow.Date);
            await MessageService.Success(L["ScheduleAssignmentEndedSuccessfully"]);

            if (SelectedEmployeeDetails != null)
            {
                ScheduleAssignments = await ScheduleAppService.GetEmployeeScheduleAssignmentsAsync(SelectedEmployeeDetails.Id);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error ending schedule assignment: {ex.Message}");
        }
    }

    private async Task CloseEmployeeModal()
    {
        await EmployeeModal.Hide();
        StateHasChanged();
    }

    private async Task CloseDetailsModal()
    {
        await DetailsModal.Hide();
        StateHasChanged();
    }

    private async Task SaveEmployeeAsync()
    {
        try
        {
            if (EditingEmployee == null)
            {
                await MessageService.Error("Employee data is missing.");
                return;
            }

            IsSaving = true;

            if (EditingEmployeeId == null)
            {
                await EmployeeAppService.CreateAsync(EditingEmployee);
            }
            else
            {
                await EmployeeAppService.UpdateAsync(EditingEmployeeId.Value, EditingEmployee);
            }

            await CloseEmployeeModal();
            await LoadEmployeesAsync();
            await MessageService.Success(L["SuccessfullySaved"]);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error saving: {ex.Message}");
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task ActivateEmployeeAsync(Guid id)
    {
        try
        {
            if (await MessageService.Confirm(L["ActivateConfirmation"]))
            {
                await EmployeeAppService.ActivateAsync(id);
                await LoadEmployeesAsync();
                await MessageService.Success(L["SuccessfullyActivated"]);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error: {ex.Message}");
        }
    }

    private async Task DeactivateEmployeeAsync(Guid id)
    {
        try
        {
            if (await MessageService.Confirm(L["DeactivateConfirmation"]))
            {
                await EmployeeAppService.DeactivateAsync(id);
                await LoadEmployeesAsync();
                await MessageService.Success(L["SuccessfullyDeactivated"]);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error: {ex.Message}");
        }
    }

    private async Task ExportToExcelAsync()
    {
        try
        {
            IsExporting = true;
            StateHasChanged();

            var fileBytes = await EmployeeAppService.ExportToExcelAsync();
            var fileName = $"Employees_{DateTime.UtcNow:yyyyMMdd_HHmmss}.xlsx";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));

            await MessageService.Success(L["SuccessfullyExported"]);
        }
        catch (Exception ex)
        {
            await MessageService.Error(L["ExportError"] + ": " + ex.Message);
        }
        finally
        {
            IsExporting = false;
            StateHasChanged();
        }
    }

    private async Task DownloadTemplateAsync()
    {
        try
        {
            IsDownloadingTemplate = true;
            StateHasChanged();

            var fileBytes = await EmployeeAppService.DownloadImportTemplateAsync();
            var fileName = "Employee_Import_Template.xlsx";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));

            await MessageService.Success(L["TemplateDownloaded"]);
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error downloading template: {ex.Message}");
        }
        finally
        {
            IsDownloadingTemplate = false;
            StateHasChanged();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
                return;

            if (!file.Name.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase) && 
                !file.Name.EndsWith(".xls", StringComparison.OrdinalIgnoreCase))
            {
                await MessageService.Error(L["InvalidFileFormat"]);
                return;
            }

            IsImporting = true;
            StateHasChanged();

            using (var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)) // 10MB max
            using (var memoryStream = new MemoryStream())
            {
                await stream.CopyToAsync(memoryStream);
                var fileBytes = memoryStream.ToArray();

                ImportResult = await EmployeeAppService.ImportFromExcelAsync(fileBytes);

                // Reload employees if any were successfully imported
                if (ImportResult.SuccessCount > 0)
                {
                    await LoadEmployeesAsync();
                }

                // Show results modal
                await ImportResultsModal.Show();
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error importing file: {ex.Message}");
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }

    private async Task CloseImportResultsModal()
    {
        await ImportResultsModal.Hide();
        ImportResult = null;
        StateHasChanged();
    }
}
@page "/pending-approvals"
@using AttendanceManagement.Dtos.ExceptionRequests
@using AttendanceManagement.Interfaces
@using AttendanceManagement.Permissions
@using AttendanceManagement.Enums
@using Volo.Abp.AspNetCore.Components.Messages
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(AttendanceManagementPermissions.ExceptionRequests.Approve)]
@inject IExceptionRequestAppService ExceptionRequestAppService
@inject IUiMessageService MessageService
@inject IAuthorizationService AuthorizationService
@inject IStringLocalizer<AttendanceManagementResource> L
@inherits AbpComponentBase

<div class="modern-page-wrapper">
    <div class="glass-card">
        @* Header Section *@
        <div class="gradient-header">
            <div class="gradient-header-content">
                <Row Class="justify-content-between align-items-center">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex align-items-center gap-3">
                            <div class="header-icon-box">
                                <Icon Name="IconName.Hourglass" />
                            </div>
                            <div>
                                <Heading Size="HeadingSize.Is3" TextColor="TextColor.White" Margin="Margin.Is0">
                                    @L["PendingApprovals"]
                                </Heading>
                                <p class="text-white-50 mb-0 mt-1 small">@L["ReviewAndApproveExceptionRequests"]</p>
                            </div>
                        </div>
                    </Column>
                </Row>
            </div>
        </div>

        @* Loading State *@
        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="modern-spinner mx-auto mb-3"></div>
                <p class="text-muted">@L["Loading"]</p>
            </div>
        }
        else if (PendingRequests != null && PendingRequests.Any())
        {
            @* Content Section *@
            <div class="px-4 pb-4">
                <div class="modern-table-wrapper">
                    <Table Class="modern-table" Margin="Margin.Is0">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>@L["Employee"]</TableHeaderCell>
                                <TableHeaderCell>@L["Date"]</TableHeaderCell>
                                <TableHeaderCell>@L["Type"]</TableHeaderCell>
                                <TableHeaderCell>@L["Reason"]</TableHeaderCell>
                                <TableHeaderCell>@L["CurrentStep"]</TableHeaderCell>
                                <TableHeaderCell>@L["SubmittedOn"]</TableHeaderCell>
                                <TableHeaderCell>@L["Actions"]</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var request in PendingRequests)
                            {
                                <TableRow>
                                    <TableRowCell>
                                        <strong>@(request.EmployeeName ?? "-")</strong>
                                    </TableRowCell>
                                    <TableRowCell>@request.ExceptionDate.ToString("yyyy-MM-dd (dddd)")</TableRowCell>
                                    <TableRowCell>
                                        @if (request.Type == ExceptionRequestType.Sick)
                                        {
                                            <Badge Color="Color.Danger">@L["Sick"]</Badge>
                                        }
                                        else
                                        {
                                            <Badge Color="Color.Warning">@L["SpecialCondition"]</Badge>
                                        }
                                    </TableRowCell>
                                    <TableRowCell>
                                        @if (!string.IsNullOrEmpty(request.Reason))
                                        {
                                            @(request.Reason.Length > 50 ? request.Reason.Substring(0, 50) + "..." : request.Reason)
                                        }
                                    </TableRowCell>
                                    <TableRowCell>@request.CurrentStepOrder</TableRowCell>
                                    <TableRowCell>@request.CreationTime.ToString("yyyy-MM-dd")</TableRowCell>
                                    <TableRowCell>
                                        <Button Color="Color.Success" Size="Size.Small" Clicked="@(() => OpenApprovalModalAsync(request.Id, ApprovalAction.Approved))">
                                            <Icon Name="IconName.Check" /> @L["Approve"]
                                        </Button>
                                        <Button Color="Color.Danger" Size="Size.Small" Clicked="@(() => OpenApprovalModalAsync(request.Id, ApprovalAction.Rejected))" Margin="Margin.Is1.FromStart">
                                            <Icon Name="IconName.Times" /> @L["Reject"]
                                        </Button>
                                        <Button Color="Color.Info" Size="Size.Small" Clicked="@(() => ViewRequestDetailsAsync(request.Id))" Margin="Margin.Is1.FromStart">
                                            <Icon Name="IconName.Eye" /> @L["Details"]
                                        </Button>
                                    </TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                </div>
            </div>
        }
        else
        {
            <div class="p-5">
                <div class="alert-modern">
                    <h4 class="alert-modern-heading">
                        <Icon Name="IconName.InfoCircle" Margin="Margin.Is1.FromEnd" />
                        @L["NoPendingApprovals"]
                    </h4>
                    <p class="alert-modern-text mb-0">
                        @L["NoPendingApprovalsMessage"]
                    </p>
                </div>
            </div>
        }
    </div>
</div>

@* Approval Modal *@
<Modal @ref="ApprovalModal">
    <ModalContent Centered="true">
        <Form>
            <ModalHeader>
                <ModalTitle>
                    @if (ApprovalInput != null)
                    {
                        @(ApprovalInput.Action == ApprovalAction.Approved ? L["ApproveRequest"] : L["RejectRequest"])
                    }
                </ModalTitle>
                <CloseButton Clicked="CloseApprovalModalAsync" />
            </ModalHeader>
            <ModalBody>
                @if (ApprovalInput != null)
                {
                    <Alert Color="@(ApprovalInput.Action == ApprovalAction.Approved ? Color.Success : Color.Danger)" Visible="true">
                        <AlertDescription>
                            @if (ApprovalInput.Action == ApprovalAction.Approved)
                            {
                                <Icon Name="IconName.Check" /> 
                                @L["ApproveConfirmationMessage"]
                            }
                            else
                            {
                                <Icon Name="IconName.Times" /> 
                                @L["RejectConfirmationMessage"]
                            }
                        </AlertDescription>
                    </Alert>

                    <Field>
                        <FieldLabel>@L["Notes"]</FieldLabel>
                        <MemoEdit @bind-Text="@ApprovalInput.Notes" Rows="4" Placeholder="@L["OptionalNotes"]" />
                    </Field>
                }
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="CloseApprovalModalAsync">@L["Cancel"]</Button>
                @if (ApprovalInput != null)
                {
                    <Button Color="@(ApprovalInput.Action == ApprovalAction.Approved ? Color.Success : Color.Danger)"
                            Clicked="SubmitApprovalAsync"
                            Loading="@IsProcessing">
                        @(ApprovalInput.Action == ApprovalAction.Approved ? L["Approve"] : L["Reject"])
                    </Button>
                }
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

@* Details Modal *@
<Modal @ref="DetailsModal">
    <ModalContent Centered="true" Size="ModalSize.Large">
        <ModalHeader>
            <ModalTitle>@L["RequestDetails"]</ModalTitle>
            <CloseButton Clicked="CloseDetailsModalAsync" />
        </ModalHeader>
        <ModalBody>
            @if (SelectedRequest != null)
            {
                <div class="container-fluid">
                    <Row Margin="Margin.Is4.FromBottom">
                        <Column ColumnSize="ColumnSize.Is6">
                            <Field>
                                <FieldLabel>@L["Employee"]</FieldLabel>
                                <FieldBody>
                                    <p class="mb-0">@(SelectedRequest.EmployeeName ?? "-")</p>
                                </FieldBody>
                            </Field>
                        </Column>
                        <Column ColumnSize="ColumnSize.Is6">
                            <Field>
                                <FieldLabel>@L["ExceptionDate"]</FieldLabel>
                                <FieldBody>
                                    <p class="mb-0">@SelectedRequest.ExceptionDate.ToString("yyyy-MM-dd (dddd)")</p>
                                </FieldBody>
                            </Field>
                        </Column>
                    </Row>

                    <Row Margin="Margin.Is4.FromBottom">
                        <Column ColumnSize="ColumnSize.Is6">
                            <Field>
                                <FieldLabel>@L["Type"]</FieldLabel>
                                <FieldBody>
                                    @if (SelectedRequest.Type == ExceptionRequestType.Sick)
                                    {
                                        <Badge Color="Color.Danger">@L["Sick"]</Badge>
                                    }
                                    else
                                    {
                                        <Badge Color="Color.Warning">@L["SpecialCondition"]</Badge>
                                    }
                                </FieldBody>
                            </Field>
                        </Column>
                        <Column ColumnSize="ColumnSize.Is6">
                            <Field>
                                <FieldLabel>@L["Status"]</FieldLabel>
                                <FieldBody>
                                    @switch (SelectedRequest.Status)
                                    {
                                        case ExceptionRequestStatus.Pending:
                                            <Badge Color="Color.Warning">@L["Pending"]</Badge>
                                            break;
                                        case ExceptionRequestStatus.Approved:
                                            <Badge Color="Color.Success">@L["Approved"]</Badge>
                                            break;
                                        case ExceptionRequestStatus.Rejected:
                                            <Badge Color="Color.Danger">@L["Rejected"]</Badge>
                                            break;
                                        case ExceptionRequestStatus.Cancelled:
                                            <Badge Color="Color.Secondary">@L["Cancelled"]</Badge>
                                            break;
                                    }
                                </FieldBody>
                            </Field>
                        </Column>
                    </Row>

                    <Row Margin="Margin.Is4.FromBottom">
                        <Column>
                            <Field>
                                <FieldLabel>@L["Reason"]</FieldLabel>
                                <FieldBody>
                                    <p class="mb-0">@(string.IsNullOrWhiteSpace(SelectedRequest.Reason) ? "-" : SelectedRequest.Reason)</p>
                                </FieldBody>
                            </Field>
                        </Column>
                    </Row>

                    <Row Margin="Margin.Is4.FromBottom">
                        <Column>
                            <Field>
                                <FieldLabel>@L["SubmittedOn"]</FieldLabel>
                                <FieldBody>
                                    <p class="mb-0">@SelectedRequest.CreationTime.ToString("yyyy-MM-dd HH:mm")</p>
                                </FieldBody>
                            </Field>
                        </Column>
                    </Row>

                @if (SelectedRequest.Attachments != null && SelectedRequest.Attachments.Any())
                {
                    <Divider Margin="Margin.Is4.FromTop" />
                    <h5 class="mb-3">@L["Attachments"]</h5>
                    <ListGroup>
                        @foreach (var attachment in SelectedRequest.Attachments)
                        {
                            <ListGroupItem>
                                <Icon Name="IconName.FileAlt" Margin="Margin.Is1.FromEnd" />
                                <span>@attachment.FileName</span>
                            </ListGroupItem>
                        }
                    </ListGroup>
                }

                @if (SelectedRequest.ApprovalHistories != null && SelectedRequest.ApprovalHistories.Any())
                {
                    <Divider Margin="Margin.Is4.FromTop" />
                    <h5 class="mb-3">@L["ApprovalHistory"]</h5>
                    <Table Striped="true" Hoverable="true" Responsive="true">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>@L["Step"]</TableHeaderCell>
                                <TableHeaderCell>@L["Approver"]</TableHeaderCell>
                                <TableHeaderCell>@L["Action"]</TableHeaderCell>
                                <TableHeaderCell>@L["Notes"]</TableHeaderCell>
                                <TableHeaderCell>@L["Date"]</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var history in SelectedRequest.ApprovalHistories.OrderBy(h => h.StepOrder))
                            {
                                <TableRow>
                                    <TableRowCell>@history.StepOrder</TableRowCell>
                                    <TableRowCell>@(history.ApproverEmployeeName ?? "-")</TableRowCell>
                                    <TableRowCell>
                                        @switch (history.Action)
                                        {
                                            case ApprovalAction.Approved:
                                                <Badge Color="Color.Success">@L["Approved"]</Badge>
                                                break;
                                            case ApprovalAction.Rejected:
                                                <Badge Color="Color.Danger">@L["Rejected"]</Badge>
                                                break;
                                            case ApprovalAction.Pending:
                                                <Badge Color="Color.Warning">@L["Pending"]</Badge>
                                                break;
                                        }
                                    </TableRowCell>
                                    <TableRowCell>@(string.IsNullOrWhiteSpace(history.Notes) ? "-" : history.Notes)</TableRowCell>
                                    <TableRowCell>@history.ActionDateTime.ToString("yyyy-MM-dd HH:mm")</TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                }
                </div>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseDetailsModalAsync">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private List<ExceptionRequestDto> PendingRequests { get; set; } = new();
    private Modal ApprovalModal { get; set; }
    private Modal DetailsModal { get; set; }

    private ApproveRejectExceptionRequestDto ApprovalInput { get; set; }
    private ExceptionRequestDto SelectedRequest { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool IsProcessing { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadPendingApprovalsAsync();
        }
        catch
        {
            PendingRequests = new List<ExceptionRequestDto>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPendingApprovalsAsync()
    {
        try
        {
            IsLoading = true;
            StateHasChanged();
            
            var result = await ExceptionRequestAppService.GetPendingApprovalsAsync();
            PendingRequests = result ?? new List<ExceptionRequestDto>();
        }
        catch (Exception ex)
        {
            PendingRequests = new List<ExceptionRequestDto>();
            try
            {
                await MessageService.Error($"Error loading approvals: {ex.Message}");
            }
            catch
            {
                // Ignore message service errors to prevent cascading
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenApprovalModalAsync(Guid requestId, ApprovalAction action)
    {
        try
        {
            ApprovalInput = new ApproveRejectExceptionRequestDto
            {
                ExceptionRequestId = requestId,
                Action = action,
                Notes = string.Empty
            };
            if (ApprovalModal != null)
            {
                await ApprovalModal.Show();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            try
            {
                await MessageService.Error($"Error opening modal: {ex.Message}");
            }
            catch { }
        }
    }

    private async Task CloseApprovalModalAsync()
    {
        try
        {
            if (ApprovalModal != null)
            {
                await ApprovalModal.Hide();
            }
            StateHasChanged();
        }
        catch { }
    }

    private async Task SubmitApprovalAsync()
    {
        try
        {
            if (ApprovalInput == null)
            {
                try
                {
                    await MessageService.Error("Approval data is missing.");
                }
                catch { }
                return;
            }

            IsProcessing = true;
            StateHasChanged();

            await ExceptionRequestAppService.ApproveOrRejectAsync(ApprovalInput);
            await LoadPendingApprovalsAsync();
            await CloseApprovalModalAsync();

            try
            {
                await MessageService.Success(
                    ApprovalInput.Action == ApprovalAction.Approved
                        ? L["RequestApprovedSuccessfully"]
                        : L["RequestRejectedSuccessfully"]
                );
            }
            catch { }
        }
        catch (Exception ex)
        {
            try
            {
                await MessageService.Error(ex.Message);
            }
            catch { }
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ViewRequestDetailsAsync(Guid id)
    {
        try
        {
            SelectedRequest = await ExceptionRequestAppService.GetAsync(id);
            if (DetailsModal != null)
            {
                await DetailsModal.Show();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            try
            {
                await MessageService.Error($"Error loading details: {ex.Message}");
            }
            catch { }
        }
    }

    private async Task CloseDetailsModalAsync()
    {
        try
        {
            if (DetailsModal != null)
            {
                await DetailsModal.Hide();
            }
            StateHasChanged();
        }
        catch { }
    }
}

@page "/"
@using AttendanceManagement.Interfaces
@using AttendanceManagement.Dtos.Schedules
@using AttendanceManagement.Dtos.ExceptionRequests
@using AttendanceManagement.Enums
@using Volo.Abp.AspNetCore.Components.Messages
@using Microsoft.AspNetCore.Authorization
@inherits AttendanceManagementComponentBase
@inject IEmployeeAppService EmployeeAppService
@inject IScheduleAppService ScheduleAppService
@inject IExceptionRequestAppService ExceptionRequestAppService
@inject IUiMessageService MessageService
@inject IAuthorizationService AuthorizationService

<div class="row mb-3">
    <div class="@GetEmployeeCardClass() d-flex">
        <div class="card h-lg-100 w-100">
            <div class="card-body">
                <h4 class="mb-3">@GetEmployeeCardTitle()</h4>
                @if (IsLoading)
                {
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }
                else if (CurrentEmployeeDetails != null)
                {
                    <p class="h5 mb-1">@CurrentEmployeeDetails.Name</p>
                    <p class="text-muted mb-3">@CurrentEmployeeDetails.UserId</p>

                    <dl class="row mb-0">
                        <dt class="col-4">@L["Department"]</dt>
                        <dd class="col-8">@CurrentEmployeeDetails.Department</dd>

                        <dt class="col-4">@L["Sector"]</dt>
                        <dd class="col-8">@CurrentEmployeeDetails.Sector</dd>

                        <dt class="col-4">@L["Group"]</dt>
                        <dd class="col-8">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.GroupName) ? CurrentEmployeeDetails.GroupName : "-")</dd>

                        <dt class="col-4">@L["Workflow"]</dt>
                        <dd class="col-8">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.WorkflowName) ? CurrentEmployeeDetails.WorkflowName : "-")</dd>

                        <dt class="col-4">@L["PrimaryManager"]</dt>
                        <dd class="col-8">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.PrimaryManagerName) ? CurrentEmployeeDetails.PrimaryManagerName : "-")</dd>

                        <dt class="col-4">@L["Status"]</dt>
                        <dd class="col-8">
                            @if (CurrentEmployeeDetails.IsActive)
                            {
                                <Badge Color="Color.Success">@L["Active"]</Badge>
                            }
                            else
                            {
                                <Badge Color="Color.Secondary">@L["Inactive"]</Badge>
                            }
                        </dd>
                    </dl>
                }
                else
                {
                    <Alert Color="Color.Info" Visible="true" Class="mt-3">
                        <AlertDescription>@L["ExternalUserMessage"]</AlertDescription>
                    </Alert>
                }
            </div>
        </div>
    </div>

    @if (CurrentEmployeeDetails != null)
    {
        <div class="col-xl-8 col-lg-7 col-12 d-flex">
            <div class="card h-lg-100 w-100">
                <div class="card-body">
                    <h4 class="mb-3">@L["MySchedule"]</h4>

                    @if (IsLoading)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (UpcomingDays != null && UpcomingDays.Any())
                    {
                        @if (!string.IsNullOrEmpty(CurrentScheduleName))
                        {
                            <p class="mb-2">
                                <strong>@L["ScheduleName"]:</strong> @CurrentScheduleName
                            </p>
                        }
                        @if (!string.IsNullOrEmpty(SeatNumber) || !string.IsNullOrEmpty(FloorNumber))
                        {
                            <p class="mb-3">
                                <strong>@L["Seat"]:</strong> @(SeatNumber ?? "-"),
                                <strong>@L["Floor"]:</strong> @(FloorNumber ?? "-")
                            </p>
                        }

                        <Table Striped="true" Responsive="true">
                            <TableHeader>
                                <TableRow>
                                    <TableHeaderCell>@L["Date"]</TableHeaderCell>
                                    <TableHeaderCell>@L["Day"]</TableHeaderCell>
                                    <TableHeaderCell>@L["WorkLocation"]</TableHeaderCell>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                @foreach (var day in UpcomingDays)
                                {
                                    <TableRow>
                                        <TableRowCell>@day.Date.ToString("yyyy-MM-dd")</TableRowCell>
                                        <TableRowCell>@day.Date.ToString("dddd")</TableRowCell>
                                        <TableRowCell>
                                            @if (day.IsOnSite)
                                            {
                                                <Badge Color="Color.Primary">@L["OnSite"]</Badge>
                                            }
                                            else
                                            {
                                                <Badge Color="Color.Info">@L["Remote"]</Badge>
                                            }
                                        </TableRowCell>
                                    </TableRow>
                                }
                            </TableBody>
                        </Table>
                    }
                    else
                    {
                        <Alert Color="Color.Info" Visible="true" Class="mt-3">
                            <AlertDescription>@L["NoScheduleAssigned"]</AlertDescription>
                        </Alert>
                    }
                </div>
            </div>
        </div>
    }
</div>

<div class="row mt-3">
    @if (CurrentEmployeeDetails != null)
    {
        <div class="col-xl-8 col-12 d-flex">
            <div class="card h-lg-100 w-100">
                <div class="card-body">
                    <h4 class="mb-3">@L["MyExceptionRequests"]</h4>

                    @if (IsLoading)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (MyRequests != null && MyRequests.Any())
                    {
                        <div class="row mb-3">
                            <div class="col-6 col-md-3">
                                <p class="text-muted mb-1">@L["Pending"]</p>
                                <p class="h5">@PendingCount</p>
                            </div>
                            <div class="col-6 col-md-3">
                                <p class="text-muted mb-1">@L["Approved"]</p>
                                <p class="h5">@ApprovedCount</p>
                            </div>
                            <div class="col-6 col-md-3">
                                <p class="text-muted mb-1">@L["Rejected"]</p>
                                <p class="h5">@RejectedCount</p>
                            </div>
                            <div class="col-6 col-md-3">
                                <p class="text-muted mb-1">@L["Cancelled"]</p>
                                <p class="h5">@CancelledCount</p>
                            </div>
                        </div>

                        <Table Striped="true" Responsive="true">
                            <TableHeader>
                                <TableRow>
                                    <TableHeaderCell>@L["Date"]</TableHeaderCell>
                                    <TableHeaderCell>@L["Type"]</TableHeaderCell>
                                    <TableHeaderCell>@L["Reason"]</TableHeaderCell>
                                    <TableHeaderCell>@L["Status"]</TableHeaderCell>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                @foreach (var req in MyRequests.OrderByDescending(r => r.CreationTime).Take(5))
                                {
                                    <TableRow>
                                        <TableRowCell>@req.ExceptionDate.ToString("yyyy-MM-dd")</TableRowCell>
                                        <TableRowCell>
                                            @if (req.Type == ExceptionRequestType.Sick)
                                            {
                                                <Badge Color="Color.Danger">@L["Sick"]</Badge>
                                            }
                                            else
                                            {
                                                <Badge Color="Color.Warning">@L["SpecialCondition"]</Badge>
                                            }
                                        </TableRowCell>
                                        <TableRowCell>
                                            @if (!string.IsNullOrEmpty(req.Reason))
                                            {
                                                @(req.Reason.Length > 40 ? req.Reason.Substring(0, 40) + "..." : req.Reason)
                                            }
                                        </TableRowCell>
                                        <TableRowCell>
                                            @switch (req.Status)
                                            {
                                                case ExceptionRequestStatus.Pending:
                                                    <Badge Color="Color.Warning">@L["Pending"]</Badge>
                                                    break;
                                                case ExceptionRequestStatus.Approved:
                                                    <Badge Color="Color.Success">@L["Approved"]</Badge>
                                                    break;
                                                case ExceptionRequestStatus.Rejected:
                                                    <Badge Color="Color.Danger">@L["Rejected"]</Badge>
                                                    break;
                                                case ExceptionRequestStatus.Cancelled:
                                                    <Badge Color="Color.Secondary">@L["Cancelled"]</Badge>
                                                    break;
                                            }
                                        </TableRowCell>
                                    </TableRow>
                                }
                            </TableBody>
                        </Table>
                    }
                    else
                    {
                        <Alert Color="Color.Info" Visible="true" Class="mt-3">
                            <AlertDescription>@L["NoRecordsFound"]</AlertDescription>
                        </Alert>
                    }
                </div>
            </div>
        </div>
    }

    @if (CanApprove)
    {
        <div class="col-xl-4 col-12 d-flex">
            <div class="card h-lg-100 w-100">
                <div class="card-body">
                    <h4 class="mb-3">@L["PendingApprovals"]</h4>

                    @if (IsLoading)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (PendingApprovalsCount == 0)
                    {
                        <p class="text-muted mb-0">@L["NoPendingApprovals"]</p>
                    }
                    else
                    {
                        <p class="display-6 mb-1">@PendingApprovalsCount</p>
                        <p class="text-muted">@L["PendingApprovals"]</p>
                        <a href="/pending-approvals" class="btn btn-primary btn-sm">
                            @L["ViewDetails"]
                        </a>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private EmployeeWithDetailsDto CurrentEmployeeDetails { get; set; }

    private string CurrentScheduleName { get; set; }
    private string SeatNumber { get; set; }
    private string FloorNumber { get; set; }

    private List<UpcomingScheduleDay> UpcomingDays { get; set; } = new();

    private List<ExceptionRequestDto> MyRequests { get; set; } = new();
    private int PendingCount { get; set; }
    private int ApprovedCount { get; set; }
    private int RejectedCount { get; set; }
    private int CancelledCount { get; set; }

    private int PendingApprovalsCount { get; set; }
    private bool CanApprove { get; set; }

    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!CurrentUser.Id.HasValue)
            {
                IsLoading = false;
                return;
            }

            await LoadEmployeeAsync();
            await LoadScheduleSummaryAsync();
            await LoadRequestsSummaryAsync();
            await LoadPendingApprovalsSummaryAsync();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadEmployeeAsync()
    {
        try
        {
            var employees = await EmployeeAppService.GetActiveEmployeesAsync();
            var currentEmployee = employees?.FirstOrDefault(e => e.UserId == CurrentUser.Id.Value);

            if (currentEmployee != null)
            {
                CurrentEmployeeDetails = await EmployeeAppService.GetWithDetailsAsync(currentEmployee.Id);
            }
            // If no employee record found (e.g., doctor/external user), CurrentEmployeeDetails remains null
        }
        catch
        {
            // User might not have permission to view employees or might be external user (doctor)
            CurrentEmployeeDetails = null;
        }
    }

    private async Task LoadScheduleSummaryAsync()
    {
        if (CurrentEmployeeDetails == null)
        {
            return;
        }

        var assignment = await ScheduleAppService.GetEmployeeCurrentScheduleAsync(CurrentEmployeeDetails.Id);
        if (assignment == null)
        {
            return;
        }

        CurrentScheduleName = assignment.ScheduleName;
        SeatNumber = assignment.SeatNumber;
        FloorNumber = assignment.FloorNumber;

        var schedule = await ScheduleAppService.GetAsync(assignment.ScheduleId);
        var days = schedule.ScheduleDays?.ToList() ?? new List<ScheduleDayDto>();

        UpcomingDays.Clear();
        for (int i = 0; i < 7; i++)
        {
            var date = DateTime.Today.AddDays(i);
            var dayOfWeek = date.DayOfWeek;
            var dayDef = days.FirstOrDefault(d => d.DayOfWeek == dayOfWeek);

            if (dayDef != null)
            {
                UpcomingDays.Add(new UpcomingScheduleDay
                {
                    Date = date,
                    IsOnSite = dayDef.IsOnSite
                });
            }
        }
    }

    private async Task LoadRequestsSummaryAsync()
    {
        try
        {
            // Only load requests if user is an employee
            if (CurrentEmployeeDetails != null)
            {
                MyRequests = await ExceptionRequestAppService.GetMyRequestsAsync() ?? new List<ExceptionRequestDto>();

                PendingCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Pending);
                ApprovedCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Approved);
                RejectedCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Rejected);
                CancelledCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Cancelled);
            }
            else
            {
                // External users (doctors) don't have their own requests
                MyRequests = new List<ExceptionRequestDto>();
                PendingCount = 0;
                ApprovedCount = 0;
                RejectedCount = 0;
                CancelledCount = 0;
            }
        }
        catch
        {
            // User might not have permission or might be external user
            MyRequests = new List<ExceptionRequestDto>();
            PendingCount = 0;
            ApprovedCount = 0;
            RejectedCount = 0;
            CancelledCount = 0;
        }
    }

    private async Task LoadPendingApprovalsSummaryAsync()
    {
        CanApprove = await AuthorizationService.IsGrantedAsync(AttendanceManagementPermissions.ExceptionRequests.Approve);
        if (!CanApprove)
        {
            PendingApprovalsCount = 0;
            return;
        }

        try
        {
            var pending = await ExceptionRequestAppService.GetPendingApprovalsAsync();
            PendingApprovalsCount = pending?.Count ?? 0;
        }
        catch
        {
            PendingApprovalsCount = 0;
        }
    }

    private string GetEmployeeCardClass()
    {
        return CurrentEmployeeDetails != null ? "col-xl-4 col-lg-5 col-12" : "col-12";
    }

    private string GetEmployeeCardTitle()
    {
        return CurrentEmployeeDetails != null ? L["Employees"] : L["UserInfo"];
    }

    private class UpcomingScheduleDay
    {
        public DateTime Date { get; set; }
        public bool IsOnSite { get; set; }
    }
}



@page "/"
@using AttendanceManagement.Interfaces
@using AttendanceManagement.Dtos.Schedules
@using AttendanceManagement.Dtos.ExceptionRequests
@using AttendanceManagement.Enums
@using Volo.Abp.AspNetCore.Components.Messages
@using Microsoft.AspNetCore.Authorization
@inherits AttendanceManagementComponentBase
@attribute [Authorize]
@inject IEmployeeAppService EmployeeAppService
@inject IScheduleAppService ScheduleAppService
@inject IExceptionRequestAppService ExceptionRequestAppService
@inject IUiMessageService MessageService
@inject IAuthorizationService AuthorizationService

<div class="container-fluid py-4">
    @* First Row: Employee Info & Schedule *@
    <div class="row g-4 mb-4">
        @* Employee Information Card *@
        <div class="@GetEmployeeCardClass()">
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <h4 class="dashboard-card-title">
                        <Icon Name="IconName.User" />
                        @GetEmployeeCardTitle()
                    </h4>
                </div>
                <div class="dashboard-card-body">
                    @if (IsLoading)
                    {
                        <div class="text-center py-4">
                            <div class="modern-spinner mx-auto"></div>
                        </div>
                    }
                    else if (CurrentEmployeeDetails != null)
                    {
                        <div class="text-center mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle mb-3" style="width: 70px; height: 70px;">
                                <Icon Name="IconName.User" IconSize="IconSize.x2" Color="Color.Primary" />
                            </div>
                            <h5 class="mb-1 fw-bold">@CurrentEmployeeDetails.Name</h5>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.Mail" Margin="Margin.Is1.FromEnd" />
                                @L["Email"]
                            </div>
                            <div class="employee-info-value">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.Email) ? CurrentEmployeeDetails.Email : "-")</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.IdCard" Margin="Margin.Is1.FromEnd" />
                                @L["CompanyId"]
                            </div>
                            <div class="employee-info-value">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.CompanyId) ? CurrentEmployeeDetails.CompanyId : "-")</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.Briefcase" Margin="Margin.Is1.FromEnd" />
                                @L["Department"]
                            </div>
                            <div class="employee-info-value">@CurrentEmployeeDetails.Department</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.Building" Margin="Margin.Is1.FromEnd" />
                                @L["Sector"]
                            </div>
                            <div class="employee-info-value">@CurrentEmployeeDetails.Sector</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.Users" Margin="Margin.Is1.FromEnd" />
                                @L["Group"]
                            </div>
                            <div class="employee-info-value">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.GroupName) ? CurrentEmployeeDetails.GroupName : "-")</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.Briefcase" Margin="Margin.Is1.FromEnd" />
                                @L["Workflow"]
                            </div>
                            <div class="employee-info-value">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.WorkflowName) ? CurrentEmployeeDetails.WorkflowName : "-")</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.UserTie" Margin="Margin.Is1.FromEnd" />
                                @L["PrimaryManager"]
                            </div>
                            <div class="employee-info-value">@(!string.IsNullOrEmpty(CurrentEmployeeDetails.PrimaryManagerName) ? CurrentEmployeeDetails.PrimaryManagerName : "-")</div>
                        </div>

                        <div class="employee-info-item">
                            <div class="employee-info-label">
                                <Icon Name="IconName.CheckCircle" Margin="Margin.Is1.FromEnd" />
                                @L["Status"]
                            </div>
                            <div class="employee-info-value">
                                @if (CurrentEmployeeDetails.IsActive)
                                {
                                    <Badge Color="Color.Success">
                                        <Icon Name="IconName.Check" />
                                        @L["Active"]
                                    </Badge>
                                }
                                else
                                {
                                    <Badge Color="Color.Secondary">@L["Inactive"]</Badge>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert-modern">
                            <h5 class="alert-modern-heading">
                                <Icon Name="IconName.InfoCircle" />
                                @L["ExternalUser"]
                            </h5>
                            <p class="alert-modern-text mb-0">@L["ExternalUserMessage"]</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* My Schedule Card *@
        @if (CurrentEmployeeDetails != null)
        {
            <div class="col-xl-8 col-lg-7 col-12">
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <h4 class="dashboard-card-title">
                            <Icon Name="IconName.Calendar" />
                            @L["MySchedule"]
                        </h4>
                    </div>
                    <div class="dashboard-card-body">
                        @if (IsLoading)
                        {
                            <div class="text-center py-4">
                                <div class="modern-spinner mx-auto"></div>
                            </div>
                        }
                        else if (ScheduleDays != null && ScheduleDays.Any())
                        {
                            @if (!string.IsNullOrEmpty(CurrentScheduleName))
                            {
                                <div class="d-flex align-items-center gap-3 mb-3 p-3 rounded" style="background: #eff6ff; border-left: 4px solid var(--ejada-primary);">
                                    <Icon Name="IconName.CalendarCheck" IconSize="IconSize.Large" Color="Color.Primary" />
                                    <div>
                                        <div class="fw-semibold text-muted small mb-1">@L["ScheduleName"]</div>
                                        <div class="fs-5 fw-bold text-dark">@CurrentScheduleName</div>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(SeatNumber) || !string.IsNullOrEmpty(FloorNumber))
                            {
                                <div class="d-flex gap-3 mb-4">
                                    <div class="flex-fill p-3 rounded" style="background: #f8fafc; border-left: 3px solid #3b82f6;">
                                        <div class="small text-muted mb-1">
                                            <Icon Name="IconName.MapMarkerAlt" />
                                            @L["Seat"]
                                        </div>
                                        <div class="fw-bold">@(SeatNumber ?? "-")</div>
                                    </div>
                                    <div class="flex-fill p-3 rounded" style="background: #f8fafc; border-left: 3px solid #f59e0b;">
                                        <div class="small text-muted mb-1">
                                            <Icon Name="IconName.Building" />
                                            @L["Floor"]
                                        </div>
                                        <div class="fw-bold">@(FloorNumber ?? "-")</div>
                                    </div>
                                </div>
                            }

                            <WeekScheduleTable 
                                ScheduleDays="@GetScheduleDaysForComponent()" 
                                SeatNumber="@SeatNumber" 
                                FloorNumber="@FloorNumber" 
                                DaysToShow="7" />
                        }
                        else
                        {
                            <div class="alert-modern">
                                <p class="alert-modern-text mb-0">@L["NoScheduleAssigned"]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    @* Second Row: Exception Requests & Pending Approvals *@
    <div class="row g-4">
        @* My Exception Requests Card *@
        @if (CurrentEmployeeDetails != null)
        {
            <div class="col-xl-8 col-12">
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <h4 class="dashboard-card-title">
                            <Icon Name="IconName.FileAlt" />
                            @L["MyExceptionRequests"]
                        </h4>
                    </div>
                    <div class="dashboard-card-body">
                        @if (IsLoading)
                        {
                            <div class="text-center py-4">
                                <div class="modern-spinner mx-auto"></div>
                            </div>
                        }
                        else if (MyRequests != null && MyRequests.Any())
                        {
                            <div class="stats-grid mb-4">
                                <div class="stat-item">
                                    <div class="stat-label">
                                        <Icon Name="IconName.Clock" />
                                        @L["Pending"]
                                    </div>
                                    <div class="stat-value" style="color: #f59e0b;">@PendingCount</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">
                                        <Icon Name="IconName.CheckCircle" />
                                        @L["Approved"]
                                    </div>
                                    <div class="stat-value" style="color: #10b981;">@ApprovedCount</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">
                                        <Icon Name="IconName.TimesCircle" />
                                        @L["Rejected"]
                                    </div>
                                    <div class="stat-value" style="color: #ef4444;">@RejectedCount</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">
                                        <Icon Name="IconName.Ban" />
                                        @L["Cancelled"]
                                    </div>
                                    <div class="stat-value" style="color: #6b7280;">@CancelledCount</div>
                                </div>
                            </div>

                            <div class="modern-table-wrapper">
                                <Table Class="modern-table" Margin="Margin.Is0">
                                    <TableHeader>
                                        <TableRow>
                                            <TableHeaderCell>@L["Date"]</TableHeaderCell>
                                            <TableHeaderCell>@L["Type"]</TableHeaderCell>
                                            <TableHeaderCell>@L["Reason"]</TableHeaderCell>
                                            <TableHeaderCell>@L["Status"]</TableHeaderCell>
                                        </TableRow>
                                    </TableHeader>
                                    <TableBody>
                                        @foreach (var req in MyRequests.OrderByDescending(r => r.CreationTime).Take(5))
                                        {
                                            <TableRow>
                                                <TableRowCell>
                                                    <strong>@req.ExceptionDate.ToString("yyyy-MM-dd")</strong>
                                                </TableRowCell>
                                                <TableRowCell>
                                                    @if (req.Type == ExceptionRequestType.Sick)
                                                    {
                                                        <Badge Color="Color.Danger">
                                                            <Icon Name="IconName.ClinicMedical" />
                                                            @L["Sick"]
                                                        </Badge>
                                                    }
                                                    else
                                                    {
                                                        <Badge Color="Color.Warning">
                                                            <Icon Name="IconName.ExclamationTriangle" />
                                                            @L["SpecialCondition"]
                                                        </Badge>
                                                    }
                                                </TableRowCell>
                                                <TableRowCell>
                                                    @if (!string.IsNullOrEmpty(req.Reason))
                                                    {
                                                        <span>@(req.Reason.Length > 40 ? req.Reason.Substring(0, 40) + "..." : req.Reason)</span>
                                                    }
                                                </TableRowCell>
                                                <TableRowCell>
                                                    @switch (req.Status)
                                                    {
                                                        case ExceptionRequestStatus.Pending:
                                                            <Badge Color="Color.Warning">
                                                                <Icon Name="IconName.Clock" />
                                                                @L["Pending"]
                                                            </Badge>
                                                            break;
                                                        case ExceptionRequestStatus.Approved:
                                                            <Badge Color="Color.Success">
                                                                <Icon Name="IconName.Check" />
                                                                @L["Approved"]
                                                            </Badge>
                                                            break;
                                                        case ExceptionRequestStatus.Rejected:
                                                            <Badge Color="Color.Danger">
                                                                <Icon Name="IconName.Times" />
                                                                @L["Rejected"]
                                                            </Badge>
                                                            break;
                                                        case ExceptionRequestStatus.Cancelled:
                                                            <Badge Color="Color.Secondary">
                                                                <Icon Name="IconName.Ban" />
                                                                @L["Cancelled"]
                                                            </Badge>
                                                            break;
                                                    }
                                                </TableRowCell>
                                            </TableRow>
                                        }
                                    </TableBody>
                                </Table>
                            </div>
                        }
                        else
                        {
                            <div class="alert-modern">
                                <p class="alert-modern-text mb-0">@L["NoRecordsFound"]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @* Pending Approvals Card *@
        @if (CanApprove)
        {
            <div class="col-xl-4 col-12">
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <h4 class="dashboard-card-title">
                            <Icon Name="IconName.Hourglass" />
                            @L["PendingApprovals"]
                        </h4>
                    </div>
                    <div class="dashboard-card-body">
                        @if (IsLoading)
                        {
                            <div class="text-center py-4">
                                <div class="modern-spinner mx-auto"></div>
                            </div>
                        }
                        else if (PendingApprovalsCount == 0)
                        {
                            <div class="text-center py-4">
                                <Icon Name="IconName.CheckCircle" IconSize="IconSize.x4" Color="Color.Success" Margin="Margin.Is3.FromBottom" />
                                <p class="text-muted mb-0">@L["NoPendingApprovals"]</p>
                            </div>
                        }
                        else
                        {
                            <div class="approvals-highlight">
                                <div class="approvals-count">@PendingApprovalsCount</div>
                                <div class="approvals-label">@L["PendingApprovals"]</div>
                            </div>
                            <a href="/pending-approvals" class="btn-modern w-100 text-center text-decoration-none">
                                <Icon Name="IconName.Eye" />
                                <span>@L["ViewDetails"]</span>
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private EmployeeWithDetailsDto CurrentEmployeeDetails { get; set; }
    private string CurrentScheduleName { get; set; }
    private string SeatNumber { get; set; }
    private string FloorNumber { get; set; }
    private List<ScheduleDayDto> ScheduleDays { get; set; } = new();
    private List<ExceptionRequestDto> MyRequests { get; set; } = new();
    private int PendingCount { get; set; }
    private int ApprovedCount { get; set; }
    private int RejectedCount { get; set; }
    private int CancelledCount { get; set; }
    private int PendingApprovalsCount { get; set; }
    private bool CanApprove { get; set; }
    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!CurrentUser.Id.HasValue)
            {
                IsLoading = false;
                return;
            }

            await LoadEmployeeAsync();
            await LoadScheduleSummaryAsync();
            await LoadRequestsSummaryAsync();
            await LoadPendingApprovalsSummaryAsync();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadEmployeeAsync()
    {
        try
        {
            var employees = await EmployeeAppService.GetActiveEmployeesAsync();
            var currentEmployee = employees?.FirstOrDefault(e => e.UserId == CurrentUser.Id.Value);

            if (currentEmployee != null)
            {
                CurrentEmployeeDetails = await EmployeeAppService.GetWithDetailsAsync(currentEmployee.Id);
            }
        }
        catch
        {
            CurrentEmployeeDetails = null;
        }
    }

    private async Task LoadScheduleSummaryAsync()
    {
        if (CurrentEmployeeDetails == null) return;

        var assignment = await ScheduleAppService.GetEmployeeCurrentScheduleAsync(CurrentEmployeeDetails.Id);
        if (assignment == null) return;

        CurrentScheduleName = assignment.ScheduleName;
        SeatNumber = assignment.SeatNumber;
        FloorNumber = assignment.FloorNumber;

        var schedule = await ScheduleAppService.GetAsync(assignment.ScheduleId);
        ScheduleDays = schedule.ScheduleDays?.ToList() ?? new List<ScheduleDayDto>();
    }

    private List<ScheduleDayDto> GetScheduleDaysForComponent()
    {
        return ScheduleDays ?? new List<ScheduleDayDto>();
    }

    private async Task LoadRequestsSummaryAsync()
    {
        try
        {
            if (CurrentEmployeeDetails != null)
            {
                MyRequests = await ExceptionRequestAppService.GetMyRequestsAsync() ?? new List<ExceptionRequestDto>();
                PendingCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Pending);
                ApprovedCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Approved);
                RejectedCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Rejected);
                CancelledCount = MyRequests.Count(r => r.Status == ExceptionRequestStatus.Cancelled);
            }
            else
            {
                MyRequests = new List<ExceptionRequestDto>();
                PendingCount = ApprovedCount = RejectedCount = CancelledCount = 0;
            }
        }
        catch
        {
            MyRequests = new List<ExceptionRequestDto>();
            PendingCount = ApprovedCount = RejectedCount = CancelledCount = 0;
        }
    }

    private async Task LoadPendingApprovalsSummaryAsync()
    {
        CanApprove = await AuthorizationService.IsGrantedAsync(AttendanceManagementPermissions.ExceptionRequests.Approve);
        if (!CanApprove)
        {
            PendingApprovalsCount = 0;
            return;
        }

        try
        {
            var pending = await ExceptionRequestAppService.GetPendingApprovalsAsync();
            PendingApprovalsCount = pending?.Count ?? 0;
        }
        catch
        {
            PendingApprovalsCount = 0;
        }
    }

    private string GetEmployeeCardClass()
    {
        return CurrentEmployeeDetails != null ? "col-xl-4 col-lg-5 col-12" : "col-12";
    }

    private string GetEmployeeCardTitle()
    {
        return CurrentEmployeeDetails != null ? L["Employees"] : L["UserInfo"];
    }
}